{% extends 'base.html' %}
{% block title %}{{ exam.name }} – MRI Planning Guide{% endblock %}
{% block content %}

<!-- HEADER -->
<div class="bg-cuf-navy text-white py-8 px-6">
  <div class="max-w-5xl mx-auto">
    <nav class="flex items-center gap-2 text-xs text-cuf-muted mb-4 flex-wrap">
      <a href="{{ url_for('index') }}" class="hover:text-white transition">Início</a>
      <span>›</span>
      <a href="{{ url_for('category', category_id=exam.cat_id) }}" class="hover:text-white transition">{{ exam.cat_name }}</a>
      <span>›</span>
      <span class="text-white">{{ exam.name }}</span>
    </nav>
    <div class="flex items-start justify-between gap-4 flex-wrap">
      <div>
        <div class="flex items-center gap-3 mb-2 flex-wrap">
          <span class="badge" style="background:{{ exam.cat_color }}22;border:1px solid {{ exam.cat_color }}44;color:{{ exam.cat_color }};">
            {{ exam.cat_name }}
          </span>
          <span class="badge {% if 'sem' in exam.contrast|lower and 'com' not in exam.contrast|lower %}badge-green{% else %}badge-amber{% endif %}">
            {% if 'sem' in exam.contrast|lower and 'com' not in exam.contrast|lower %}
              ○ Sem contraste
            {% else %}
              ◉ {{ exam.contrast }}
            {% endif %}
          </span>
        </div>
        <h1 class="font-display font-700 text-4xl tracking-wide">{{ exam.name }}</h1>
        {% if exam.description %}
        <p class="text-cuf-border text-sm mt-2 max-w-2xl leading-relaxed">{{ exam.description }}</p>
        {% endif %}
      </div>
      {% if session.get('admin_logged_in') %}
      <a href="{{ url_for('admin_edit_exam', exam_id=exam.id) }}" class="btn-secondary text-sm shrink-0" style="border-color:rgba(255,255,255,.3);color:white;">
        ✎ Editar
      </a>
      {% endif %}
    </div>
  </div>
</div>

<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

  <!-- QUICK INFO CARDS -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
    <div class="card p-4 text-center">
      <p class="text-xs text-cuf-muted font-semibold uppercase tracking-wider mb-1">Região</p>
      <p class="font-display font-600 text-cuf-navy text-base">{{ exam.cat_name }}</p>
    </div>
    <div class="card p-4 text-center">
      <p class="text-xs text-cuf-muted font-semibold uppercase tracking-wider mb-1">Contraste</p>
      <p class="font-display font-600 text-cuf-navy text-base">{% if 'sem' in exam.contrast|lower and 'com' not in exam.contrast|lower %}Não{% else %}Sim{% endif %}</p>
    </div>
    <div class="card p-4 text-center">
      <p class="text-xs text-cuf-muted font-semibold uppercase tracking-wider mb-1">Sequências</p>
      <p class="font-display font-700 text-cuf-blue text-2xl">{{ sequences|length }}</p>
    </div>
    <div class="card p-4 text-center">
      <p class="text-xs text-cuf-muted font-semibold uppercase tracking-wider mb-1">Planos</p>
      <p class="font-display font-600 text-cuf-navy text-sm leading-tight">{% if exam.planes %}{{ exam.planes.split(',')|length }}{% else %}—{% endif %}</p>
    </div>
  </div>

  <!-- PLANES OF CUT -->
  {% if exam.planes %}
  <div class="card p-6">
    <h2 class="section-title text-sm mb-5">Planos de Corte</h2>
    <div class="flex flex-wrap gap-3">
      {% for plane in exam.planes.split(',') %}
      {% set p = plane.strip() %}
      {% if p=='Axial' %}{% set icon='⊞' %}{% set col='#0071BC' %}
      {% elif p=='Sagital' %}{% set icon='⊟' %}{% set col='#0059A3' %}
      {% elif p=='Coronal' %}{% set icon='⊠' %}{% set col='#0099CC' %}
      {% else %}{% set icon='◈' %}{% set col='#003F7F' %}{% endif %}
      <div class="flex items-center gap-3 px-5 py-4 rounded-xl border-2" style="border-color:{{ col }}22;background:{{ col }}08;">
        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold border-2"
             style="border-color:{{ col }}33;background:{{ col }}12;color:{{ col }};">
          {% if p=='Axial' %}
            <!-- Axial icon: horizontal slice -->
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="{{ col }}" stroke-width="2">
              <ellipse cx="12" cy="12" rx="9" ry="4"/>
              <line x1="12" y1="3" x2="12" y2="8"/>
              <line x1="12" y1="16" x2="12" y2="21"/>
            </svg>
          {% elif p=='Sagital' %}
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="{{ col }}" stroke-width="2">
              <ellipse cx="12" cy="12" rx="4" ry="9" transform="rotate(0 12 12)"/>
              <line x1="3" y1="12" x2="8" y2="12"/>
              <line x1="16" y1="12" x2="21" y2="12"/>
            </svg>
          {% elif p=='Coronal' %}
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="{{ col }}" stroke-width="2">
              <rect x="9" y="3" width="6" height="18" rx="3"/>
              <line x1="3" y1="9" x2="9" y2="9"/>
              <line x1="3" y1="15" x2="9" y2="15"/>
              <line x1="15" y1="9" x2="21" y2="9"/>
              <line x1="15" y1="15" x2="21" y2="15"/>
            </svg>
          {% else %}
            <span style="color:{{ col }}">◈</span>
          {% endif %}
        </div>
        <div>
          <p class="font-display font-700 text-base" style="color:{{ col }};">{{ p }}</p>
          <p class="text-xs text-cuf-muted">plano de corte</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- SEQUENCES WITH IMAGES -->
  {% if sequences %}
  <div class="card p-6">
    <h2 class="section-title text-sm mb-5">Sequências do Protocolo</h2>
    <div class="space-y-4">
      {% for item in sequences %}{% set seq=item.seq %}{% set imgs=item.images %}
      <div class="border border-cuf-border rounded-xl overflow-hidden" id="seq-{{ seq.id }}">

        <!-- Sequence header -->
        <div class="flex items-center gap-3 px-4 py-3 bg-cuf-lighter border-b border-cuf-border">
          <div class="w-7 h-7 rounded-lg bg-cuf-blue text-white flex items-center justify-center font-display font-700 text-sm shrink-0">
            {{ loop.index }}
          </div>
          <p class="font-display font-600 text-cuf-navy text-base flex-1">{{ seq.name }}</p>
          {% if imgs %}
          <span class="badge badge-blue text-xs">{{ imgs|length }} img.</span>
          {% else %}
          <span class="text-xs text-cuf-muted italic">Sem imagens</span>
          {% endif %}
        </div>

        <!-- Images for this sequence -->
        {% if imgs %}
        <div class="p-4">
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
            {% for img in imgs %}
            <div class="group relative rounded-lg overflow-hidden border border-cuf-border cursor-pointer"
                 onclick="openLightbox('{{ url_for('uploaded_file', filename=img.filename) }}', '{{ seq.name }}{% if img.caption %} – {{ img.caption }}{% endif %}')">
              <img src="{{ url_for('uploaded_file', filename=img.filename) }}"
                   alt="{{ img.caption or seq.name }}"
                   class="w-full h-28 object-cover group-hover:scale-105 transition-transform duration-200"/>
              <div class="absolute inset-0 bg-cuf-navy/0 group-hover:bg-cuf-navy/30 transition-colors flex items-center justify-center">
                <svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                </svg>
              </div>
              {% if img.caption %}
              <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-cuf-navy/80 to-transparent px-2 py-1.5">
                <p class="text-white text-xs leading-tight truncate">{{ img.caption }}</p>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% else %}
        <div class="px-4 py-6 text-center">
          <p class="text-xs text-cuf-muted">Nenhuma imagem de planejamento adicionada para esta sequência.</p>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- TECHNICAL NOTES -->
  {% if exam.technical_notes %}
  <div class="card p-6">
    <h2 class="section-title text-sm mb-5">Notas Técnicas</h2>
    <div class="space-y-2.5">
      {% for note in exam.technical_notes.split('\n') %}{% if note.strip() %}
      <div class="flex items-start gap-3 p-3 rounded-lg bg-amber-50 border border-amber-100">
        <span class="text-amber-600 font-bold shrink-0 mt-0.5">◆</span>
        <p class="text-sm text-amber-900 leading-relaxed">{{ note.strip() }}</p>
      </div>
      {% endif %}{% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- GENERAL EXAM IMAGES -->
  {% if exam_images %}
  <div class="card p-6">
    <h2 class="section-title text-sm mb-5">Imagens Gerais do Exame</h2>
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
      {% for img in exam_images %}
      <div class="group relative rounded-lg overflow-hidden border border-cuf-border cursor-pointer"
           onclick="openLightbox('{{ url_for('uploaded_file', filename=img.filename) }}', '{{ img.caption or exam.name }}')">
        <img src="{{ url_for('uploaded_file', filename=img.filename) }}" class="w-full h-28 object-cover group-hover:scale-105 transition-transform duration-200"/>
        {% if img.caption %}<div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-cuf-navy/80 to-transparent px-2 py-1.5"><p class="text-white text-xs truncate">{{ img.caption }}</p></div>{% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- BACK -->
  <div class="flex gap-3">
    <a href="{{ url_for('category', category_id=exam.cat_id) }}" class="btn-secondary inline-flex items-center gap-2 text-sm">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      Voltar à Região
    </a>
    <a href="{{ url_for('index') }}" class="text-sm text-cuf-muted hover:text-cuf-navy transition inline-flex items-center gap-1 px-4 py-2">
      Início
    </a>
  </div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox" class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-cuf-navy/95 backdrop-blur-sm p-4"
     onclick="closeLightbox()">
  <p id="lightbox-caption" class="text-white text-sm mb-3 font-semibold"></p>
  <img id="lightbox-img" src="" alt="" class="max-w-full max-h-[80vh] rounded-xl shadow-2xl object-contain"/>
  <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 transition flex items-center justify-center text-xl">✕</button>
</div>

{% endblock %}
{% block scripts %}
<script>
function openLightbox(src, caption) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox-caption').textContent = caption || '';
  const lb = document.getElementById('lightbox');
  lb.classList.remove('hidden'); lb.classList.add('flex');
}
function closeLightbox() {
  const lb = document.getElementById('lightbox');
  lb.classList.add('hidden'); lb.classList.remove('flex');
}
document.addEventListener('keydown', e => { if(e.key==='Escape') closeLightbox(); });
</script>
{% endblock %}
