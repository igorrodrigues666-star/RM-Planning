{% extends 'base.html' %}
{% block title %}MRI Planning Guide – Início{% endblock %}
{% block content %}

<div class="bg-cuf-navy text-white py-10 px-6">
  <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-6">
    <div>
      <div class="badge mb-3" style="background:rgba(0,153,204,.2);border:1px solid rgba(0,153,204,.4);color:#7dcfef;">● SISTEMA ONLINE</div>
      <h1 class="font-display font-700 text-4xl sm:text-5xl tracking-wide leading-tight">Protocolos de<br/>Ressonância Magnética</h1>
      <p class="text-cuf-border text-base mt-3 max-w-lg leading-relaxed">Selecione uma região anatómica no mapa interativo ou nos cartões para consultar os protocolos de marcação.</p>
    </div>
    <div class="flex gap-6 shrink-0">
      <div class="text-center">
        <p class="font-display font-700 text-4xl text-cuf-teal">{{ cats_data|length }}</p>
        <p class="text-cuf-muted text-xs tracking-widest mt-1">REGIÕES</p>
      </div>
      <div class="w-px bg-cuf-mid"></div>
      <div class="text-center">
        {% set total=namespace(n=0) %}{% for i in cats_data %}{% set total.n=total.n+i.exams|length %}{% endfor %}
        <p class="font-display font-700 text-4xl text-white">{{ total.n }}</p>
        <p class="text-cuf-muted text-xs tracking-widest mt-1">PROTOCOLOS</p>
      </div>
    </div>
  </div>
</div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  <div class="flex flex-col xl:flex-row gap-10">

    <!-- SKELETON MAP -->
    <div class="xl:w-80 shrink-0">
      <div class="card p-5 text-center sticky top-20" style="background:#001A50;border-color:#003580;">
        <h2 class="font-display font-700 text-sm tracking-widest text-white/80 mb-1 uppercase">Mapa Anatómico</h2>
        <p class="text-white/40 text-xs mb-3">Clique numa região para ver os exames</p>

        <svg id="body-map" viewBox="0 0 220 560" xmlns="http://www.w3.org/2000/svg"
             class="mx-auto select-none" style="max-height:500px;width:100%;border-radius:8px;display:block;">
          <defs>
            <radialGradient id="bgr" cx="50%" cy="20%" r="80%">
              <stop offset="0%" stop-color="#002470"/>
              <stop offset="100%" stop-color="#00071A"/>
            </radialGradient>
            <radialGradient id="skullr" cx="50%" cy="38%" r="62%">
              <stop offset="0%" stop-color="rgba(245,253,255,1)"/>
              <stop offset="55%" stop-color="rgba(195,230,255,.96)"/>
              <stop offset="100%" stop-color="rgba(145,200,245,.86)"/>
            </radialGradient>
            <filter id="fsg" x="-55%" y="-55%" width="210%" height="210%">
              <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="b1"/>
              <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="b2"/>
              <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="b3"/>
              <feMerge><feMergeNode in="b1"/><feMergeNode in="b1"/><feMergeNode in="b2"/><feMergeNode in="b3"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <filter id="fbg" x="-20%" y="-20%" width="140%" height="140%">
              <feGaussianBlur stdDeviation="2.2" result="b"/>
              <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <filter id="fbe" x="-4%" y="-2%" width="108%" height="104%">
              <feGaussianBlur stdDeviation="1.8" result="b"/>
              <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <style>
              .bn  { fill:rgba(182,218,255,.87); stroke:rgba(218,240,255,.72); stroke-width:.55; }
              .bnb { fill:rgba(212,236,255,.94); stroke:rgba(232,246,255,.82); stroke-width:.5; }
              .cav { fill:#00071A; }
              .bs  { fill:rgba(52,92,162,.28); stroke:rgba(85,140,215,.52); stroke-width:1.25; }
              .sr  { cursor:pointer; }
              .rh  { fill:transparent; stroke:transparent; stroke-width:2; transition:fill .18s,stroke .18s; }
              .sr:hover .rh { fill:rgba(0,162,255,.16); stroke:rgba(0,190,255,.32); }
              .sr.active .rh { fill:rgba(0,162,255,.22); }
              .lbl { font-family:"Barlow Semi Condensed",sans-serif; font-size:8px; font-weight:700; fill:rgba(255,255,255,.8); text-anchor:middle; pointer-events:none; letter-spacing:.06em; }
            </style>
          </defs>

          <rect width="220" height="560" fill="url(#bgr)" rx="8"/>

          <!-- BODY SILHOUETTE -->
          <g class="bs" filter="url(#fbe)">
            <ellipse cx="110" cy="44" rx="36" ry="40"/>
            <path d="M98 81 L95 104 L125 104 L122 81Z"/>
            <path d="M62 104 Q50 112 48 134 L48 254 Q48 274 68 276 L152 276 Q172 274 172 254 L172 134 Q170 112 158 104Z"/>
            <path d="M50 132 Q34 124 26 138 L16 196 L10 264 L8 297 Q7 310 18 312 L30 312 Q44 310 46 298 L50 262 L56 192 L64 140Z"/>
            <path d="M170 132 Q186 124 194 138 L204 196 L210 264 L212 297 Q213 310 202 312 L190 312 Q176 310 174 298 L170 262 L164 192 L156 140Z"/>
            <path d="M70 276 L66 282 L58 375 Q56 390 64 395 L82 397 Q94 393 96 378 L100 284 L98 276Z"/>
            <path d="M64 395 L60 401 L54 468 Q52 482 60 486 L74 488 Q86 485 88 473 L94 403 L82 397Z"/>
            <ellipse cx="72" cy="491" rx="21" ry="8"/>
            <path d="M150 276 L154 282 L162 375 Q164 390 156 395 L138 397 Q126 393 124 378 L120 284 L122 276Z"/>
            <path d="M156 395 L160 401 L166 468 Q168 482 160 486 L146 488 Q134 485 132 473 L126 403 L138 397Z"/>
            <ellipse cx="148" cy="491" rx="21" ry="8"/>
          </g>

          <!-- SKULL – strong glow -->
          <g filter="url(#fsg)">
            <path fill="url(#skullr)" stroke="rgba(228,246,255,.78)" stroke-width=".7"
                  d="M110 8 C86 8 73 23 73 43 C73 60 79 74 88 79 L92 83 Q101 91 110 91 Q119 91 128 83 L132 79 C141 74 147 60 147 43 C147 23 134 8 110 8Z"/>
            <path fill="none" stroke="rgba(152,198,238,.44)" stroke-width=".8" stroke-dasharray="2,2" d="M96 10 Q101 22 106 36 Q109 44 110 52"/>
            <path fill="none" stroke="rgba(152,198,238,.44)" stroke-width=".7" stroke-dasharray="2,2" d="M76 42 Q94 40 110 42 Q126 40 144 42"/>
            <path fill="none" stroke="rgba(198,228,255,.48)" stroke-width="1"   d="M75 38 Q80 32 87 34 Q90 36 90 42"/>
            <path fill="none" stroke="rgba(198,228,255,.48)" stroke-width="1"   d="M145 38 Q140 32 133 34 Q130 36 130 42"/>
            <path class="bnb" d="M88 73 Q79 70 75 77 Q73 83 77 87 Q81 89 87 87 L91 83"/>
            <path class="bnb" d="M132 73 Q141 70 145 77 Q147 83 143 87 Q139 89 133 87 L129 83"/>
            <ellipse class="cav" cx="99"  cy="52" rx="12" ry="9"/>
            <ellipse class="cav" cx="121" cy="52" rx="12" ry="9"/>
            <ellipse fill="none" stroke="rgba(198,228,255,.6)" stroke-width="1.1" cx="99"  cy="52" rx="12" ry="9"/>
            <ellipse fill="none" stroke="rgba(198,228,255,.6)" stroke-width="1.1" cx="121" cy="52" rx="12" ry="9"/>
            <path fill="none" stroke="rgba(228,246,255,.65)" stroke-width=".7" d="M91 48 Q96 44 104 46"/>
            <path fill="none" stroke="rgba(228,246,255,.65)" stroke-width=".7" d="M116 44 Q124 43 129 48"/>
            <path class="cav" d="M107 64 L110 59 L113 64 L113 71 Q110 74 107 71Z"/>
            <path fill="none" stroke="rgba(198,226,255,.44)" stroke-width=".8" d="M107 64 L110 59 L113 64"/>
            <path fill="none" stroke="rgba(210,234,255,.62)" stroke-width="1" d="M103 48 Q107 55 108 61"/>
            <path fill="none" stroke="rgba(210,234,255,.62)" stroke-width="1" d="M117 48 Q113 55 112 61"/>
            <path fill="none" stroke="rgba(218,240,255,.38)" stroke-width="1"  d="M86 69 Q81 74 79 80"/>
            <path fill="none" stroke="rgba(218,240,255,.38)" stroke-width="1"  d="M134 69 Q139 74 141 80"/>
            <path fill="rgba(198,230,255,.38)" stroke="rgba(213,237,255,.48)" stroke-width=".8" d="M93 83 Q102 88 110 88 Q118 88 127 83"/>
            <path class="bnb" d="M89 83 L87 85 Q84 92 87 98 Q95 106 110 106 Q125 106 133 98 Q136 92 133 85 L131 83"/>
            <path fill="none" stroke="rgba(198,226,255,.48)" stroke-width=".8" d="M94 97 Q103 101 110 101 Q117 101 126 97"/>
            <circle class="cav" cx="101" cy="94" r="1.5"/>
            <circle class="cav" cx="119" cy="94" r="1.5"/>
          </g>

          <!-- REST OF BONES -->
          <g filter="url(#fbg)">
            <!-- Cervical vertebrae -->
            <rect class="bn" x="105.5" y="108" width="9" height="5" rx="1.5"/>
            <rect class="bn" x="105.5" y="114" width="9" height="5" rx="1.5"/>
            <rect class="bn" x="105"   y="120" width="10" height="5" rx="1.5"/>
            <rect class="bn" x="105"   y="126" width="10" height="5" rx="1.5"/>

            <!-- Clavicles -->
            <path class="bnb" d="M108 112 C95 109 77 112 62 120 Q57 123 58 128 Q60 132 65 130 C78 123 97 118 108 120Z"/>
            <path class="bnb" d="M112 112 C125 109 143 112 158 120 Q163 123 162 128 Q160 132 155 130 C142 123 123 118 112 120Z"/>

            <!-- Sternum -->
            <path class="bnb" d="M104 112 Q102 114 102 122 L102 130 Q106 134 110 134 Q114 134 118 130 L118 122 Q118 114 116 112Z"/>
            <rect class="bn" x="105" y="130" width="10" height="56" rx="2.5"/>
            <path class="bn" d="M107 186 Q110 197 113 186Z"/>

            <!-- Ribs – 7 pairs -->
            <path class="bn" fill="none" stroke-width="2.8" d="M105 121 C90 118 72 124 63 135 C57 144 61 154 69 153 C78 152 89 141 97 131 C101 126 104 123 105 121"/>
            <path class="bn" fill="none" stroke-width="2.8" d="M115 121 C130 118 148 124 157 135 C163 144 159 154 151 153 C142 152 131 141 123 131 C119 126 116 123 115 121"/>
            <path class="bn" fill="none" stroke-width="2.6" d="M105 129 C88 127 67 134 59 147 C53 158 57 169 66 168 C76 167 88 155 97 143 C102 135 104 131 105 129"/>
            <path class="bn" fill="none" stroke-width="2.6" d="M115 129 C132 127 153 134 161 147 C167 158 163 169 154 168 C144 167 132 155 123 143 C118 135 116 131 115 129"/>
            <path class="bn" fill="none" stroke-width="2.4" d="M105 137 C86 136 63 144 55 160 C49 173 54 184 63 182 C73 180 86 167 97 154 C102 145 104 140 105 137"/>
            <path class="bn" fill="none" stroke-width="2.4" d="M115 137 C134 136 157 144 165 160 C171 173 166 184 157 182 C147 180 134 167 123 154 C118 145 116 140 115 137"/>
            <path class="bn" fill="none" stroke-width="2.2" d="M105 145 C84 145 60 154 53 172 C47 186 53 197 62 194 C72 191 85 177 96 163 C102 153 104 148 105 145"/>
            <path class="bn" fill="none" stroke-width="2.2" d="M115 145 C136 145 160 154 167 172 C173 186 167 197 158 194 C148 191 135 177 124 163 C118 153 116 148 115 145"/>
            <path class="bn" fill="none" stroke-width="2.0" d="M105 153 C82 154 57 164 50 184 C44 200 51 210 60 206 C70 202 83 187 95 172 C102 162 104 156 105 153"/>
            <path class="bn" fill="none" stroke-width="2.0" d="M115 153 C138 154 163 164 170 184 C176 200 169 210 160 206 C150 202 137 187 125 172 C118 162 116 156 115 153"/>
            <path class="bn" fill="none" stroke-width="1.8" d="M105 161 C81 163 56 174 50 196 C45 212 52 222 61 217 C71 211 83 196 95 180 C102 169 105 164 105 161"/>
            <path class="bn" fill="none" stroke-width="1.8" d="M115 161 C139 163 164 174 170 196 C175 212 168 222 159 217 C149 211 137 196 125 180 C118 169 115 164 115 161"/>
            <path class="bn" fill="none" stroke-width="1.6" d="M105 169 C83 172 60 183 54 205 C50 218 56 226 65 220 C74 213 85 198 96 184"/>
            <path class="bn" fill="none" stroke-width="1.6" d="M115 169 C137 172 160 183 166 205 C170 218 164 226 155 220 C146 213 135 198 124 184"/>

            <!-- Thoracic vertebrae T1-T12 -->
            <rect class="bn" x="106" y="133" width="8" height="7" rx="1.5"/>
            <rect class="bn" x="106" y="141" width="8" height="7" rx="1.5"/>
            <rect class="bn" x="106" y="149" width="8" height="7" rx="1.5"/>
            <rect class="bn" x="106" y="157" width="8" height="7" rx="1.5"/>
            <rect class="bn" x="106" y="165" width="8" height="7" rx="1.5"/>
            <rect class="bn" x="106" y="173" width="8" height="7" rx="1.5"/>
            <rect class="bn" x="106" y="181" width="8" height="7" rx="1.5"/>
            <rect class="bn" x="105" y="189" width="10" height="7" rx="1.5"/>
            <rect class="bn" x="105" y="197" width="10" height="7" rx="1.5"/>
            <rect class="bn" x="105" y="205" width="10" height="7" rx="1.5"/>
            <rect class="bn" x="105" y="213" width="10" height="7" rx="1.5"/>
            <rect class="bn" x="105" y="221" width="10" height="7" rx="1.5"/>
            <!-- Spinous processes -->
            <path fill="none" stroke="rgba(178,213,255,.22)" stroke-width=".6"
                  d="M106 136L100 136 M106 144L100 144 M106 152L100 152 M106 160L100 160 M106 168L100 168 M106 176L100 176 M106 184L100 184"/>
            <path fill="none" stroke="rgba(178,213,255,.22)" stroke-width=".6"
                  d="M114 136L120 136 M114 144L120 144 M114 152L120 152 M114 160L120 160 M114 168L120 168 M114 176L100 176 M114 184L120 184"/>

            <!-- Lumbar vertebrae L1-L5 -->
            <rect class="bnb" x="104" y="230" width="12" height="8" rx="2"/>
            <rect class="bnb" x="104" y="239" width="12" height="8" rx="2"/>
            <rect class="bnb" x="104" y="248" width="12" height="8" rx="2"/>
            <rect class="bnb" x="104" y="257" width="12" height="8" rx="2"/>
            <rect class="bnb" x="104" y="266" width="12" height="8" rx="2"/>

            <!-- Pelvis -->
            <path class="bn" d="M110 274 C102 270 84 262 72 254 Q62 250 58 258 Q54 268 62 275 Q70 282 82 282 L98 278Z"/>
            <path class="bn" d="M110 274 C118 270 136 262 148 254 Q158 250 162 258 Q166 268 158 275 Q150 282 138 282 L122 278Z"/>
            <path class="bnb" d="M104 274 L104 292 Q110 298 116 292 L116 274Z"/>
            <path class="bn" fill="none" stroke-width="1.5" d="M82 282 Q96 288 110 290 Q124 288 138 282"/>
            <circle class="cav" cx="80"  cy="278" r="5"/>
            <circle class="cav" cx="140" cy="278" r="5"/>
            <circle fill="none" stroke="rgba(198,226,255,.5)" stroke-width="1" cx="80"  cy="278" r="5"/>
            <circle fill="none" stroke="rgba(198,226,255,.5)" stroke-width="1" cx="140" cy="278" r="5"/>

            <!-- LEFT HUMERUS -->
            <path class="bnb" d="M66 126 Q62 120 58 124 L35 208 Q32 216 36 220 Q40 224 46 220 L62 138 Q66 130 66 126Z"/>
            <ellipse class="bnb" cx="62" cy="126" rx="7" ry="6" transform="rotate(-15 62 126)"/>
            <!-- LEFT FOREARM -->
            <path class="bn" d="M38 222 L20 295 Q18 302 23 304 L28 305 Q34 303 35 296 L46 222Z"/>
            <path class="bn" d="M46 220 L36 296 Q35 303 40 305 L45 305 Q51 303 52 296 L52 220Z"/>
            <path class="bnb" d="M44 218 Q50 215 52 220 L46 222 Q42 222 38 222Z"/>

            <!-- RIGHT HUMERUS -->
            <path class="bnb" d="M154 126 Q158 120 162 124 L185 208 Q188 216 184 220 Q180 224 174 220 L158 138 Q154 130 154 126Z"/>
            <ellipse class="bnb" cx="158" cy="126" rx="7" ry="6" transform="rotate(15 158 126)"/>
            <!-- RIGHT FOREARM -->
            <path class="bn" d="M182 222 L200 295 Q202 302 197 304 L192 305 Q186 303 185 296 L174 222Z"/>
            <path class="bn" d="M174 220 L184 296 Q185 303 180 305 L175 305 Q169 303 168 296 L168 220Z"/>
            <path class="bnb" d="M176 218 Q170 215 168 220 L174 222 Q178 222 182 222Z"/>

            <!-- LEFT FEMUR -->
            <path class="bnb" d="M84 282 Q76 280 72 284 L68 372 Q67 382 73 385 L83 386 Q91 383 92 374 L95 284 Q93 278 84 282Z"/>
            <circle class="bnb" cx="80" cy="278" r="6" fill="rgba(212,236,255,.9)"/>
            <path class="bnb" d="M72 290 Q65 287 64 294 Q63 301 70 302Z"/>
            <ellipse class="bnb" cx="76" cy="384" rx="9" ry="5"/>
            <ellipse class="bnb" cx="76" cy="392" rx="7" ry="5"/>
            <!-- LEFT TIBIA+FIBULA -->
            <path class="bnb" d="M72 396 L66 464 Q65 472 70 475 L79 476 Q86 473 87 465 L84 396Z"/>
            <path class="bn"  d="M84 400 L90 462 Q91 470 87 473 L84 474 L86 464Z"/>
            <path class="bn"  d="M66 475 Q60 478 58 484 Q60 490 72 492 Q82 492 88 488 L87 478Z"/>

            <!-- RIGHT FEMUR -->
            <path class="bnb" d="M136 282 Q144 280 148 284 L152 372 Q153 382 147 385 L137 386 Q129 383 128 374 L125 284 Q127 278 136 282Z"/>
            <circle class="bnb" cx="140" cy="278" r="6" fill="rgba(212,236,255,.9)"/>
            <path class="bnb" d="M148 290 Q155 287 156 294 Q157 301 150 302Z"/>
            <ellipse class="bnb" cx="144" cy="384" rx="9" ry="5"/>
            <ellipse class="bnb" cx="144" cy="392" rx="7" ry="5"/>
            <!-- RIGHT TIBIA+FIBULA -->
            <path class="bnb" d="M148 396 L154 464 Q155 472 150 475 L141 476 Q134 473 133 465 L136 396Z"/>
            <path class="bn"  d="M136 400 L130 462 Q129 470 133 473 L136 474 L134 464Z"/>
            <path class="bn"  d="M154 475 Q160 478 162 484 Q160 490 148 492 Q138 492 132 488 L133 478Z"/>
          </g>

          <!-- INTERACTIVE OVERLAYS -->
          <g class="sr" data-region="head"        id="region-head">
            <ellipse class="rh" cx="110" cy="50" rx="44" ry="50"/>
            <text class="lbl" x="110" y="24" opacity=".65">CABEÇA</text>
          </g>
          <g class="sr" data-region="neck"        id="region-neck">
            <rect class="rh" x="90" y="96" width="40" height="18" rx="4"/>
            <text class="lbl" x="110" y="107" opacity=".65">PESCOÇO</text>
          </g>
          <g class="sr" data-region="chest"       id="region-chest">
            <path class="rh" d="M50 114 L50 198 L170 198 L170 114 Q158 104 110 104 Q62 104 50 114Z"/>
            <text class="lbl" x="110" y="136">TÓRAX</text>
          </g>
          <g class="sr" data-region="spine"       id="region-spine">
            <rect class="rh" x="100" y="114" width="20" height="162" rx="4"/>
          </g>
          <g class="sr" data-region="abdomen"     id="region-abdomen">
            <rect class="rh" x="50" y="198" width="120" height="58" rx="2"/>
            <text class="lbl" x="110" y="233">ABDÓMEN</text>
          </g>
          <g class="sr" data-region="pelvis"      id="region-pelvis">
            <path class="rh" d="M50 256 L50 280 Q50 294 72 296 Q90 300 110 300 Q130 300 148 296 Q170 294 170 280 L170 256Z"/>
            <text class="lbl" x="110" y="276">PELVE</text>
          </g>
          <g class="sr" data-region="upper_limbs" id="region-upper-l">
            <path class="rh" d="M50 114 Q32 108 22 126 L10 198 L6 264 L6 304 Q6 316 18 318 L32 318 Q46 316 48 304 L54 262 L60 192 L64 138Z"/>
            <text class="lbl" x="29" y="205" transform="rotate(-8 29 205)">MEM.</text>
            <text class="lbl" x="29" y="215" transform="rotate(-8 29 215)">SUP.</text>
          </g>
          <g class="sr" data-region="upper_limbs" id="region-upper-r">
            <path class="rh" d="M170 114 Q188 108 198 126 L210 198 L214 264 L214 304 Q214 316 202 318 L188 318 Q174 316 172 304 L166 262 L160 192 L156 138Z"/>
            <text class="lbl" x="191" y="205" transform="rotate(8 191 205)">MEM.</text>
            <text class="lbl" x="191" y="215" transform="rotate(8 191 215)">SUP.</text>
          </g>
          <g class="sr" data-region="lower_limbs" id="region-lower-l">
            <path class="rh" d="M50 280 L48 286 L40 378 Q38 394 46 400 L64 402 Q76 398 78 382 L82 290 L82 280Z"/>
            <path class="rh" d="M46 400 L42 406 L36 470 Q34 484 42 488 L58 490 Q70 487 72 476 L78 410 L64 402Z"/>
            <text class="lbl" x="56" y="428">MEM.</text>
            <text class="lbl" x="56" y="438">INF.</text>
          </g>
          <g class="sr" data-region="lower_limbs" id="region-lower-r">
            <path class="rh" d="M170 280 L172 286 L180 378 Q182 394 174 400 L156 402 Q144 398 142 382 L138 290 L138 280Z"/>
            <path class="rh" d="M174 400 L178 406 L184 470 Q186 484 178 488 L162 490 Q150 487 148 476 L142 410 L156 402Z"/>
          </g>

        </svg>

        <div class="mt-3 grid grid-cols-2 gap-1 text-left">
          {% for item in cats_data %}
          <div class="flex items-center gap-1.5 text-xs" style="color:rgba(255,255,255,.5);">
            <span class="w-2 h-2 rounded-full shrink-0" style="background:{{ item.cat.color }};"></span>
            <span class="truncate">{{ item.cat.name }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- CATEGORY CARDS -->
    <div class="flex-1">
      <h2 class="section-title mb-6 text-sm">Regiões Anatómicas</h2>
      {% if cats_data %}
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {% for item in cats_data %}{% set cat=item.cat %}{% set exams=item.exams %}
        <a href="{{ url_for('category', category_id=cat.id) }}"
           class="card p-5 flex flex-col gap-3 hover:-translate-y-0.5 transition-all duration-200 group no-underline"
           data-region-target="{{ cat.region_key }}">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-display font-700 text-sm" style="background:{{ cat.color }};">RM</div>
              <div>
                <p class="font-display font-600 text-cuf-navy text-base leading-tight group-hover:text-cuf-blue transition">{{ cat.name }}</p>
                <p class="text-xs text-cuf-muted mt-0.5">{{ exams|length }} protocolo{% if exams|length!=1 %}s{% endif %}</p>
              </div>
            </div>
            <div class="w-8 h-8 rounded-full flex items-center justify-center border border-cuf-border group-hover:border-cuf-blue group-hover:bg-cuf-light transition">
              <svg class="w-4 h-4 text-cuf-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </div>
          </div>
          {% if exams %}
          <div class="border-t border-cuf-border pt-3 space-y-1.5">
            {% for exam in exams[:4] %}
            <div class="flex items-center gap-2 text-sm text-cuf-muted">
              <div class="w-1.5 h-1.5 rounded-full shrink-0" style="background:{{ cat.color }};"></div>
              <span class="truncate">{{ exam.name }}</span>
            </div>
            {% endfor %}
            {% if exams|length > 4 %}<p class="text-xs text-cuf-muted pl-3.5">+ {{ exams|length - 4 }} mais...</p>{% endif %}
          </div>
          {% else %}
          <p class="text-xs text-cuf-muted border-t border-cuf-border pt-3">Sem protocolos cadastrados.</p>
          {% endif %}
          <div class="h-0.5 rounded-full mt-1 opacity-0 group-hover:opacity-100 transition-opacity" style="background:{{ cat.color }};"></div>
        </a>
        {% endfor %}
      </div>
      {% else %}
      <div class="card p-12 text-center">
        <h3 class="font-display font-700 text-cuf-navy text-lg mb-2">Sem categorias</h3>
        <a href="{{ url_for('admin_login') }}" class="btn-primary inline-block">Acessar Admin</a>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const regionMap = {};
{% for item in cats_data %}
regionMap["{{ item.cat.region_key }}"] = {
  url: "{{ url_for('category', category_id=item.cat.id) }}",
  name: "{{ item.cat.name }}",
  color: "{{ item.cat.color }}"
};
{% endfor %}

const tooltip = document.getElementById('skel-tooltip');

document.querySelectorAll('.sr').forEach(el => {
  const region = el.dataset.region;
  const info   = regionMap[region];
  if (!info) { el.style.opacity = '.2'; el.style.cursor = 'default'; return; }

  el.addEventListener('mouseenter', e => {
    tooltip.textContent = info.name;
    tooltip.style.display = 'block';
    document.querySelectorAll(`[data-region-target="${region}"]`).forEach(card => {
      card.style.boxShadow = `0 4px 24px ${info.color}55, 0 0 0 2px ${info.color}`;
    });
  });
  el.addEventListener('mousemove', e => {
    tooltip.style.left = (e.clientX - tooltip.offsetWidth / 2) + 'px';
    tooltip.style.top  = (e.clientY - tooltip.offsetHeight - 16) + 'px';
  });
  el.addEventListener('mouseleave', () => {
    tooltip.style.display = 'none';
    document.querySelectorAll(`[data-region-target="${region}"]`).forEach(card => card.style.boxShadow = '');
  });
  el.addEventListener('click', () => window.location.href = info.url);

  document.querySelectorAll(`[data-region-target="${region}"]`).forEach(card => {
    card.addEventListener('mouseenter', () => document.querySelectorAll(`[data-region="${region}"]`).forEach(r => r.classList.add('active')));
    card.addEventListener('mouseleave', () => document.querySelectorAll(`[data-region="${region}"]`).forEach(r => r.classList.remove('active')));
  });
});
</script>
{% endblock %}
